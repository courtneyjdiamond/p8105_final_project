---
title: "<span style='color: blue;'>Analysis</span>"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    code_folding: hide
css: styles.css
---

```{=html}
<style>
  h1 {
     font-weight: bold;
  }
</style>
```

------------------------------------------------------------------------

To explore New Yorkers' use of the Citibike program, we examined data on rides, users demographics, neighborhood disparities, and health implications. By looking at these facets individually, and then in comparison through exploratory data analysis and linear models, we sought to unravel the connections between bikes and health and answer some key questions:

-   Is social deprivation index predictive of the number of stations?
-   Is the availability of stations, or the usage patterns, indicative of overweight?
-   Do our measures of health and social status vary with citibike usage?

This page includes a few summary tables of the Citibike data, links to view deeper explorations of the air quality index, social deprivation index, and weight data, and links to our model page with full model charts and graphs.

 

# [Citibike Exploration]{style="color: blue;"}

 

## [Geographic utilization]{style="color: blue;"}

 

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(plotly)

knitr::opts_chunk$set(message = FALSE,
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

library(ggridges)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r load_data, include = FALSE}
citibike_df = read_csv("./citibike_clean/citibike_clean.csv")
stations_df = read_csv("./citibike_clean/stations.csv")
```

 

**This table shows the number of stations per neighborhood available and used in September.**

```{r station_usage}
stations_available = stations_df |>
  group_by(borough, uhf34_neighborhood) |>
  summarize(Stations_Available = n()) 

station_usage = citibike_df |>
  filter(!is.na(end_station_name) | !is.na(start_station_name)) %>%
  select(end_station_name, end_uhf34_neighborhood, 
         start_station_name, start_uhf34_neighborhood,
         start_borough, end_borough) |>
  distinct(
    Neighborhood = coalesce(end_uhf34_neighborhood, start_uhf34_neighborhood),
    Station_Name = coalesce(end_station_name, start_station_name),
    Borough = coalesce(end_borough, start_borough)
    ) |>
  group_by(Borough, Neighborhood) |>
  summarize(Stations_Used = n()) |>
  left_join(stations_available,
            by = c("Borough" = "borough",
                   "Neighborhood" = "uhf34_neighborhood")) 
station_usage |>
  arrange(Borough, desc(Stations_Used)) |>
  knitr::kable()

```

There is consistency among stations available and used, with a mean of `r mean(station_usage$Stations_Used/station_usage$Stations_Available * 100) |> round(2)` (range: `r min(station_usage$Stations_Used/station_usage$Stations_Available * 100) |> round(2)`, `r max(station_usage$Stations_Used/station_usage$Stations_Available * 100)`)

-   **Bronx has only a single station**, which makes sense given [this article](https://www.bxtimes.com/first-citi-bike-stations-installed-in-the-bronx-as-part-of-continued-expansion/) that describes Citibike expansion into the Bronx just after the time we're observing here (late 2019). While we see fairly consistent nummber of stations used to stations available, a [later article in 2023](https://comptroller.nyc.gov/newsroom/comptrollers-review-of-citi-bike-finds-worrying-decreases-in-service-reliability-under-lyfts-operation-especially-in-low-income-neighborhoods/) does show that many stations are unreliable, and that this disproportionately impacts low-income areas. So we'll see if this seems to be indicated when we incorporate SDI below.
-   Some of the biggest discrepancies in availability and usage are in the following neighborhoods: `r station_usage |> mutate(percent = Stations_Used/Stations_Available * 100) |>  filter(percent < 60) |> pull(Neighborhood)`

This graph shows that most start and end rides occurred in Manhattan in September 2019.

```{r graph of station stop/start per borough}

# Assuming citibike_df is your dataframe
combined_df <- bind_rows(
  citibike_df %>%
    group_by(borough = start_borough) %>%
    summarise(n_rides = n()) %>%
    mutate(station_type = "Start Station"),
  citibike_df %>%
    group_by(borough = end_borough) %>%
    summarise(n_rides = n()) %>%
    mutate(station_type = "End Station")
)|>
  mutate(station_type = factor(station_type, levels = c("Start Station", "End Station")))

# Create faceted plot
ggplot(combined_df, aes(x = reorder(borough, n_rides), y = n_rides, fill = borough)) +
  geom_bar(stat = "identity") +
  labs(x = "Borough", y = "Number of Rides") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_viridis_d() +  # Using viridisLite for discrete color palette
  facet_wrap(~station_type, scales = "free_x") +
  theme(legend.position = "bottom") 
```

Here are the 10 most popular starting and stopping stations in September 2019 - also in Manhattan.

```{r start stations}

combined_df <- bind_rows(
  citibike_df %>%
    group_by(station = start_station_name) %>%
    summarise(n_rides = n()) %>%
    top_n(10, wt = n_rides) %>%
    mutate(station_type = "Start Station"),
  citibike_df %>%
    group_by(station = end_station_name) %>%
    summarise(n_rides = n()) %>%
    top_n(10, wt = n_rides) %>%
    mutate(station_type = "End Station")
)|>
  mutate(station_type = factor(station_type, levels = c("Start Station", "End Station")))

ggplot(combined_df, aes(x = reorder(station, n_rides), y = n_rides, fill = station)) +
  geom_bar(stat = "identity") +
  labs(x = "Station", y = "Number of Rides") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_viridis(discrete = TRUE) + 
  facet_wrap(~station_type, scales = "free_x") +
  theme(legend.position = "bottom")


```

Add in plot for rides per day of the week here:

## [User Demographics]{style="color: blue;"}

Here is a graph of user type distribution: Subscribers take more rides!

```{r rider per subscriber}
# Count the number of rides for each user type
citibike_df %>%
  group_by(user_type) %>%
  summarise(n_rides = n()) |>
ggplot(aes(x = user_type, y = n_rides, fill = user_type)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_fill_viridis(discrete = TRUE) +
  labs(x = "User Type", y = "Number of Rides", title = "User Type Distribution")
```

Here is a graph of number of rides per gender: Males take the most rides!

```{r rides per gender}

citibike_df %>%
  group_by(gender) %>%
  summarise(n_rides = n()) |>ggplot(aes(x = gender, y = n_rides, fill = gender)) +
  geom_bar(stat = "identity") +
   scale_fill_viridis(discrete = TRUE) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(x = "Gender", y = "Number of Rides", title = "Gender Distribution")
```

This graph shows the distribution of ages: 30 year olds and 50 year olds use citibike the most!

```{r age distribution}

ggplot(citibike_df, aes(x = age, fill = "Count")) +
  geom_histogram(binwidth = 5, alpha = 0.7, color = "black") +
  scale_x_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  scale_y_continuous(labels = scales::comma_format()) +
  labs(x = "Age", y = "Number of Rides", title = "Age Distribution") +
  scale_fill_viridis(discrete = TRUE) +
  theme_minimal() +
  guides(fill = FALSE)
```

 

------------------------------------------------------------------------

# [Exploring Citibike with SDI, Overweight, and AQ ]{style="color: blue;"}

Below we get into some of the interactions between Citibike data and health outcomes. A deeper dive into this data can be found on our [dashboard](https://courtneyjdiamond.shinyapps.io/ExploratoryDashboard/) to visualize some of these exploratory analyses all together!

```{r health_plot}
health_plot = citibike_df |>
  select(start_station_latitude, start_station_longitude,
        start_sdi_score, start_percent_overweight, start_aq) |> 
  rename(lat = start_station_latitude, 
         long = start_station_longitude,
         sdi = start_sdi_score,
         overweight = start_percent_overweight,
         aq = start_aq) |>
  unique()

health_plot |>
  mutate(text_label = str_c("SDI: ", sdi, "\nOverweight (%) ", 
                            overweight, "\nAQ (PM25): ", aq)) |> 
  plot_ly(x = ~lat, y = ~long, type = "scatter", mode = "markers",
          color = ~sdi, text = ~text_label)

```

## Station Available and Usage

**Does station usage and availability vary by SDI?**

```{r sdi_stations}
stations_SDI = citibike_df |>
  filter(!is.na(end_station_name) | !is.na(start_station_name)) %>%
  select(end_station_name, end_uhf34_neighborhood, 
         start_station_name, start_uhf34_neighborhood,
         start_borough, end_borough, start_sdi_score, end_sdi_score) |>
  mutate(
    Neighborhood = coalesce(end_uhf34_neighborhood, start_uhf34_neighborhood),
    Station_Name = coalesce(end_station_name, start_station_name),
    Borough = coalesce(end_borough, start_borough),
    SDI = coalesce(start_sdi_score, end_sdi_score)
    ) |>
  group_by(Borough, Neighborhood) |>
  summarize(SDI = mean(SDI),
            Stations_Used = n_distinct(Station_Name)) |>
  left_join(stations_available,
            by = c("Borough" = "borough",
                   "Neighborhood" = "uhf34_neighborhood")) |>
  pivot_longer(c(Stations_Used, Stations_Available),names_to = "status", 
               values_to = "count")

stations_SDI |>
  ggplot(aes(x = SDI, y = count, color = status)) +
  geom_point(size = 3) +
  facet_grid(~Borough) +  
  labs(title = "Variation of Station Usage and Availability by SDI",
       x = "SDI",
       y = "Count") +
  theme_minimal()
```

There doesn't seem to be too much discernible pattern. The highest number of available stations, though, does appear in the lower SDI neighborhoods. As expected following our analysis above that usage and availability only vary for a few neighborhoods, it's not surprising that there's not much discernible difference here either!

**Does station usage and availability vary by Overweight percentage?**

```{r overweight_stations}
stations_overweight = citibike_df |>
  filter(!is.na(end_station_name) | !is.na(start_station_name)) %>%
  select(end_station_name, end_uhf34_neighborhood, 
         start_station_name, start_uhf34_neighborhood,
         start_borough, end_borough, 
         start_percent_overweight, end_percent_overweight) |>
  mutate(
    Neighborhood = coalesce(end_uhf34_neighborhood, start_uhf34_neighborhood),
    Station_Name = coalesce(end_station_name, start_station_name),
    Borough = coalesce(end_borough, start_borough),
    Overweight_pct = coalesce(start_percent_overweight, end_percent_overweight)
    ) |>
  group_by(Borough, Neighborhood) |>
  summarize(Overweight_pct = mean(Overweight_pct),
            Stations_Used = n_distinct(Station_Name)) |>
  left_join(stations_available,
            by = c("Borough" = "borough",
                   "Neighborhood" = "uhf34_neighborhood")) |>
  pivot_longer(c(Stations_Used, Stations_Available),names_to = "status", 
               values_to = "count")

stations_overweight |>
  ggplot(aes(x = Overweight_pct, y = count, color = status)) +
  geom_point() +
  facet_wrap(~Borough) +  
  labs(title = "Variation of Station Usage and Availability by Overweight Percentage",
       x = "Overweight Percentage",
       y = "Count") +
  theme_minimal()

```

For overweight percentage, there seems to be a downward trend in stations both available and used as overweight percent increases. While we can't make any causative assumptions here, it's interesting to note that the correlation is roughly the same in **available** and **used** stations - that is, individuals will use whatever stations are available, so perhaps the introduction of more stations could be beneficial to population health.

## Ridership

Let's look at the same analyses as above, but now looking at number of rides, not just available stations.

**Does September ridership vary by SDI?**

```{r sdi_rides}
rides_SDI = citibike_df |>
  filter(!is.na(end_station_name) | !is.na(start_station_name)) %>%
  select(end_station_name, end_uhf34_neighborhood, 
         start_station_name, start_uhf34_neighborhood,
         start_borough, end_borough, start_sdi_score, end_sdi_score) |>
  mutate(
    Neighborhood = coalesce(end_uhf34_neighborhood, start_uhf34_neighborhood),
    Station_Name = coalesce(end_station_name, start_station_name),
    Borough = coalesce(end_borough, start_borough),
    SDI = coalesce(start_sdi_score, end_sdi_score)
    ) |>
  group_by(Borough, Neighborhood) |>
  summarize(SDI = mean(SDI),
            rides = n()) 

rides_SDI |>
  ggplot(aes(x = SDI, y = rides)) + geom_point() + 
  geom_smooth(se = FALSE)
```

There seems to be a clear downward trend in ridership as SDI increases. However, our sample size is limited here to only 20. If we look by zipcode, we have a bit more sample, 53 distinct zipcodes.

**Does September ridership vary by SDI, at the zipcode level?**

```{r sdi_rides_zipcode}
rides_SDI = citibike_df |>
  select(start_zipcode, end_zipcode, 
         start_sdi_score, end_sdi_score) |>
  mutate(
    Zipcode = coalesce(start_zipcode, end_zipcode),
    SDI = coalesce(start_sdi_score, end_sdi_score)
    ) |>
  group_by(Zipcode) |>
  summarize(SDI = mean(SDI),
            rides = n()) 

rides_SDI |>
  ggplot(aes(x = SDI, y = rides)) + geom_point() + 
  geom_smooth(se = FALSE) 
```

Both of these visualizations showa clear downward trend in ridership as SDI increases, but they also show low ridership at the lowest end of SDI. Perhaps this speaks to alternative modes of transportation that people take at both ends of the SDI spectrum.

**Does September ridership vary by overweight percentage?**

We'll look at variation in ridership by percentage overweight, and keep in mind variation in SDI as well.

```{r overweight_rides_zipcode}
rides_SDI_overweight = citibike_df |>
  select(start_zipcode, end_zipcode, 
         start_sdi_score, end_sdi_score,
         start_percent_overweight, end_percent_overweight) |>
  mutate(
    Zipcode = coalesce(start_zipcode, end_zipcode),
    SDI = coalesce(start_sdi_score, end_sdi_score),
    Overweight_percent = coalesce(start_percent_overweight, end_percent_overweight)
    ) |>
  group_by(Zipcode) |>
  summarize(SDI = mean(SDI),
            Overweight_percent = mean(Overweight_percent),
            rides = n()) 


rides_SDI_overweight |>
  ggplot(aes(x = Overweight_percent, y = rides)) + 
  geom_point(aes(size = SDI), alpha = .75) + 
  geom_smooth(se = FALSE) 
```

Unlike SDI, there doesn't seem to be a dip in ridership for the low range of overweight percentage. Here, there is a more consistent decrease in ridership as overweight percentage increases.

 

------------------------------------------------------------------------

# [Exploring Subsets ]{style="color: blue;"}

[Air Quality index](exploratory/AirQual_exploratory.html)

[Social deprivation Index](exploratory/SDI_Exploratory.html)

[Overweight Trends](exploratory/Weight_exploratory.html)

 

------------------------------------------------------------------------

# [Modeling]{style="color: blue;"}

We sought to develop linear models that would characterize the number of rides per station as a surrogate for utilization of citibikes. Predictors included Air quality measures, social deprivation index, and percentage of overweight individuals in a neighborhood.

We then built on these models and looked at the outcomes of these metrics, based on the other metrics and citibike utilization.

[Models](modeling/Modeling.html)
