---
title: Visualizing AQI, SDI, and Overweight Data by Citibike Station
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(plotly)
library(here)
library(shiny)
library(shinyjs)


knitr::opts_chunk$set(message = FALSE,
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

library(ggridges)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r datasets, include = FALSE}
# setwd("./exploratory_dashboard")

citibike_df = read_csv("data/citibike_clean.csv")
stations_df = read_csv("data/stations.csv")

```

Column {.sidebar}
-----------------------------------------------------------------------

This is a test header.


```{r inputs, echo = FALSE}

borough = citibike_df |> 
  pull(start_borough) |> 
  unique()


selectInput(
  inputId = "borough_choice",
  label = h3("Select a Borough"),
  choices = borough,
  selected = "Manhattan"
)

hr()

extra_variable = c("AQI", "SDI", "Percent Overweight")

radioButtons(
  inputId = "health_var",
  label = h3("Select a Health Metric"),
  choices = extra_variable,
  selected = "AQI"
)

```


Row {data-height = 350}
-----------------------------------------------------------------------

### Health Metrics by Citibike Station Location

```{r, echo = FALSE}

renderPlotly({

borough_here = input$borough_choice

if (input$health_var == "AQI") {
  
  citibike_df |>
  filter(start_borough == borough_here) |> 
  distinct(start_station_name, .keep_all = TRUE) |> 
  select(start_station_name, start_zipcode, start_station_latitude, start_station_longitude, start_uhf34_neighborhood, start_borough, start_sdi_score, start_percent_overweight, start_aq) |> 
  mutate(text_label = str_c("Station: ", start_station_name, "\nAQI: ", start_aq, "\nPercent Overweight: ", start_percent_overweight, "\nSDI: ", start_sdi_score)) |> 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers", color = ~start_aq, text = ~text_label, alpha = 0.5)
  
}


else if (input$health_var == "Percent Overweight") {
  citibike_df |>
  filter(start_borough == borough_here) |> 
  distinct(start_station_name, .keep_all = TRUE) |> 
  select(start_station_name, start_zipcode, start_station_latitude, start_station_longitude, start_uhf34_neighborhood, start_borough, start_sdi_score, start_percent_overweight, start_aq) |> 
  mutate(text_label = str_c("Station: ", start_station_name, "\nAQI: ", start_aq, "\nPercent Overweight: ", start_percent_overweight, "\nSDI: ", start_sdi_score)) |> 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers", color = ~start_percent_overweight, text = ~text_label, alpha = 0.5)
}

else if (input$health_var == "SDI") {
  
  citibike_df |>
  filter(start_borough == borough_here) |> 
  distinct(start_station_name, .keep_all = TRUE) |> 
  select(start_station_name, start_zipcode, start_station_latitude, start_station_longitude, start_uhf34_neighborhood, start_borough, start_sdi_score, start_percent_overweight, start_aq) |> 
  mutate(text_label = str_c("Station: ", start_station_name, "\nAQI: ", start_aq, "\nPercent Overweight: ", start_percent_overweight, "\nSDI: ", start_sdi_score)) |> 
  plot_ly(x = ~start_station_longitude, y = ~start_station_latitude, type = "scatter", mode = "markers", color = ~start_sdi_score, text = ~text_label, alpha = 0.5)
  
}
  
})

```


### Sankey chart of most frequent rides taken from station to station

```{r, echo = FALSE}

fig <- plot_ly(
    type = "sankey",
    orientation = "h",

    node = list(
      label = c("A1", "A2", "B1", "B2", "C1", "C2"),
      color = c("blue", "blue", "blue", "blue", "blue", "blue"),
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = c(0,1,0,2,3,3),
      target = c(2,3,3,4,4,5),
      value =  c(8,4,2,8,4,2)
    )
  )
fig <- fig %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

```



Row {.tabset .tabset-fade} 
-----------------------------------------------------------------------

### Rides originating, by Citibike station
```{r, echo = FALSE}

renderPlotly({

borough_here = input$borough_choice

if (input$health_var == "AQI") {
  
  citibike_df |>
  filter(start_borough == borough_here) |> 
  add_count(start_station_name, name = "station_count") |> 
  distinct(start_station_name, .keep_all = TRUE) |> 
  select(start_station_name, start_uhf34_neighborhood, start_borough, station_count, start_sdi_score, start_percent_overweight, start_aq) |> 
  mutate(start_station_name = fct_reorder(start_station_name, station_count)) |> 
  mutate(station_count = as.numeric(station_count)) |> 
  plot_ly(x = ~start_station_name, y = ~station_count, type = "bar", color = ~start_uhf34_neighborhood)
  
}


else if (input$health_var == "Percent Overweight"){
  
  citibike_df |>
  filter(start_borough == borough_here) |> 
  add_count(start_station_name, name = "station_count") |> 
  distinct(start_station_name, .keep_all = TRUE) |> 
  select(start_station_name, start_uhf34_neighborhood, start_borough, station_count, start_sdi_score, start_percent_overweight, start_aq) |> 
  mutate(start_station_name = fct_reorder(start_station_name, station_count)) |> 
  mutate(station_count = as.numeric(station_count)) |> 
  plot_ly(x = ~start_station_name, y = ~station_count, type = "bar", color = ~start_uhf34_neighborhood)
  
}

else if (input$health_var == "SDI") {
  
  citibike_df |>
  filter(start_borough == borough_here) |> 
  add_count(start_station_name, name = "station_count") |> 
  distinct(start_station_name, .keep_all = TRUE) |> 
  select(start_station_name, start_uhf34_neighborhood, start_borough, station_count, start_sdi_score, start_percent_overweight, start_aq) |> 
  mutate(start_station_name = fct_reorder(start_station_name, station_count)) |> 
  mutate(station_count = as.numeric(station_count)) |> 
  plot_ly(x = ~start_station_name, y = ~station_count, type = "bar", color = ~start_uhf34_neighborhood)

}

})
```

### Rides terminating, by Citibike station

```{r, echo = FALSE}
renderPlotly({

borough_here = input$borough_choice

if (input$health_var == "AQI") {
  
  citibike_df |>
  filter(end_borough == borough_here) |> 
  add_count(end_station_name, name = "station_count") |> 
  distinct(end_station_name, .keep_all = TRUE) |> 
  select(end_station_name, end_uhf34_neighborhood, end_borough, station_count, end_sdi_score, end_percent_overweight, end_aq) |> 
  mutate(end_station_name = fct_reorder(end_station_name, station_count)) |> 
  plot_ly(x = ~end_station_name, y = ~station_count, type = "bar", color = ~end_uhf34_neighborhood)
  
}


else if (input$health_var == "Percent Overweight"){
  
  citibike_df |>
  filter(end_borough == borough_here) |> 
  add_count(end_station_name, name = "station_count") |> 
  distinct(end_station_name, .keep_all = TRUE) |> 
  select(end_station_name, end_uhf34_neighborhood, end_borough, station_count, end_sdi_score, end_percent_overweight, end_aq) |> 
  mutate(end_station_name = fct_reorder(end_station_name, station_count)) |> 
  plot_ly(x = ~end_station_name, y = ~station_count, type = "bar", color = ~end_uhf34_neighborhood)
  
}

else if (input$health_var == "SDI") {
  
  citibike_df |>
  filter(end_borough == borough_here) |> 
  add_count(end_station_name, name = "station_count") |> 
  distinct(end_station_name, .keep_all = TRUE) |> 
  select(end_station_name, end_uhf34_neighborhood, end_borough, station_count, end_sdi_score, end_percent_overweight, end_aq) |> 
  mutate(end_station_name = fct_reorder(end_station_name, station_count)) |> 
  plot_ly(x = ~end_station_name, y = ~station_count, type = "bar", color = ~end_uhf34_neighborhood)
  
}

})
```



