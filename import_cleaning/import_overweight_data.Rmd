---
title: "Import Overweight Data"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(message = FALSE,
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

library(tidyverse)
library(ggplot2)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

# Import Data 
Data Source: [NYC Data Portal](https://a816-dohbesp.nyc.gov/IndicatorPublic/beta/data-explorer/overweight/?id=2061#display=summary) 

  * Data accessed: `11/27/2023` 
  * Full table loaded for "Overweight and Obese Adults"

```{r import_data}
data = read_csv('./data/SDI_data/nyc_overweight_or_obesity_adults.csv') |>
    janitor::clean_names()

tidy_weight =
  data |>
  mutate(number = gsub("\\*", "", number)) |>
  mutate(number = gsub(",", "", number)) |>
  mutate(number = as.numeric(number)) |>
  mutate(
    percent_low = as.numeric(gsub("^.*\\(\\s*", "", gsub("\\s*,.*$", "", percent))),
    percent_high = as.numeric(gsub("^.*\\,\\s*", "", gsub("\\)$", "", percent))),
percent = as.numeric(ifelse(grepl("\\*", percent),
                                gsub("\\*.*$", "", percent),
                                gsub("\\s*\\(.*", "", percent)))) |>
  rename(year = time)
```

```{r plot, eval = FALSE, include = FALSE}
# Create the scatter plot with lines

borough_ggplot =
  tidy_weight |>
  filter(geo_type == "Borough") |>
ggplot(aes(x = year, y = percent, color = geography, group = geography)) +
  geom_point() +  # Add points for each data point
  geom_line() +   # Add lines to connect the same geography
  labs(title = "Borough change over time, 2005 - 2020", x = "Year", y = "Percent")   # Add  labels

print("borough_ggplot")
ggsave("exploratory/weight_exploratory_files/borough_weight_average_over_time.pdf")

```

```{r percent_change }
percent_change = tidy_weight |> 
  select(geography, year, percent, number) |>
  group_by(geography) |>
  pivot_wider(names_from = year, 
              values_from = c(percent,number)) |>
  mutate(percent_diff19_20 = (percent_2020 - percent_2019)/ percent_2019 * 100) |>
  mutate(percent_diff18_19 = (percent_2019 - percent_2018) /percent_2018 * 100) |>
  select(geography, percent_diff18_19, percent_diff19_20, percent_2018, percent_2019, percent_2020)
  

```

There are `r percent_change |> filter(abs(percent_diff18_19) > 5 | abs(percent_diff19_20) > 5) |> nrow()` areas with >5% change yoy between 2018, 2019, 2020. There are `r percent_change |> filter(abs(percent_diff18_19) > 10 | abs(percent_diff19_20) > 10) |> nrow()` areas with >10% change yoy between 2018, 2019, 2020. There are `r percent_change |> filter(abs(percent_diff18_19) > 15 | abs(percent_diff19_20) > 15) |> nrow()` areas with >15% change yoy between 2018, 2019, 2020. 

Looking at areas with >15% 
```{r}
percent_change |>
  filter(abs(percent_diff18_19) > 15 | abs(percent_diff19_20) > 15) |>
  select(geography, percent_2018, percent_2019, percent_2020) |>
  print()
```

# Save
```{r save_clean}
data_2019 = tidy_weight |>
  filter(year == 2019)

write_csv(data_2019, "data/SDI_data/overweight_data_clean.csv")

```






