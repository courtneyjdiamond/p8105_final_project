---
title: "Modeling"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    code_folding: hide
css: styles.css
---

```{r libraries, include = FALSE}
library(tidyverse)
library(mgcv)
library(modelr)
library(purrr)
library(here)

knitr::opts_chunk$set(message = FALSE,
	echo = TRUE,
	warning = FALSE
)
```

# Modeling Health Outcomes


Before diving into understanding how [health metrics play into Citibike usage](Modeling.html),
we wanted to explore interactions among the health metrics themselves. 

* Note: Details on the datasources and how they were impored and cleaned can be found at [Data Sources](data_sources.html). Here, we'll just read in CSV's generated from those tidied dataframes! 

```{r setup, include=FALSE}
library(tidyverse)
library(mgcv)
library(modelr)
library(purrr)
knitr::opts_chunk$set(message = FALSE,
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
```


# Load Health Data 


```{r}
data = read_csv('../citibike_clean/sdi_overweight.csv') |>
  select(uhf34, uhf34_neighborhood, percent_overweight, sdi_score)

aq_df = read_csv("../citibike_clean/air_quality_clean.csv") |>
  rename(uhf34 = geo_join_id,
         neighborhood = geo_place_name)
  #select(-measure, -geo_type_name, -time_period, 
   #      -start_date, -message, -year) ```
```

## Combine Health Data
```{r combine}
data = data |>
  left_join(y = aq_df,
            by = join_by(uhf34)) |>
  rename(pm25 = data_value)

head(data) |>
  knitr::kable()
```

## Group by uhf34
```{r}
data = data |> group_by(uhf34, uhf34_neighborhood) |>
  summarize(sdi = mean(sdi_score),
            overweight = mean(percent_overweight),
            pm25 = mean(pm25)) |>
  filter(!is.na(uhf34))

head(data) |> 
  knitr::kable()
```


```{r scatter}
scatter_plot = data |>
  ggplot(aes(x = sdi, y = overweight)) + geom_point()


```


## Build Health model 
```{r}
fit = lm(overweight ~ sdi, data = data)

fit |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |>
  knitr::kable(digits = 3)

scatter_plot + geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue")

```

This means that for every one-unit increase in sdi, overweight is estimated to increase by 0.194 units, assuming all other factors remain constant. They are positively correlated, but not very strongly. 


# Regression Models for Statistical Analyses 

For regression analysis, the merged data set was created by reading in Air Quality, Social Disparity Index, overweight percentages and merged with our Citibike dataset for 2019. To convert zip code data to neighborhoods we utilized ufh34/42 coding. 

This finalized dataset was imported in as `citibike.df`.

```{r load data}
citibike.df = read_csv("../citibike_clean/citibike_clean.csv")

```


## Citibike + health metrics modeling

Our exploratory analyses noted some interesting trends in the Citibike data for NYC by location. This is coupled with interesting trends in health metrics:

* For both Fine Particles and Nitrogen dioxoide Greenpoint had the highest values, and South Beach - Tottenville the lowest. 

* For SDI scores, there was some variability in ranges based on grouping by zip code, uhf34 or uhf43 neighborhood classifications. However, across them all there were large ranges in scores from 10-100.

* Percentage of neighorhood residents who were overweight varied broadly from the low 30%, with the lowest being Upper East Side-Gramercy, and up to nearly 80% in Rockaways. 

As such we elected to model potential interactions between the mean aggregate rides in geographic neighborhoods in NYC and Air Quality Index (AQI), SDI, and percentage overweight to see if they could predict citibike usage in a geographic area. 

We first summarized the citibike ride data by start station to make a new variable, `n_rides`. We then also calculate mean values of each of the health metrics for the start station location (`mean_aq`, `mean_sdi`, and `mean_overweight`) and end station (`mean_end_aq`, `mean_end_sdi`, and `mean_end_overweight`). 

```{r location summaries, eval = TRUE}
citibike_group_by_station <- citibike.df %>%
  group_by(start_station_name) %>%
  summarize(n_rides = n(), 
            mean_aq = mean(start_aq),
            mean_sdi = mean(start_sdi_score), 
            mean_overweight = mean(start_percent_overweight), 
            mean_end_aq = mean(end_aq),
            mean_end_sdi = mean(end_sdi_score),
            mean_end_overweight = mean(end_percent_overweight),
            mean_age = mean(age)
  )
```

##Our first model:

Outcome: Mean number of rides per start station
Predictors: Health metrics for the location the start station is located in: Mean_AQI, Mean_SDI, Mean_Overweight

```{r first model}
fit_model = lm(n_rides ~ mean_aq + mean_sdi + mean_overweight, data = citibike_group_by_station)

fit_model %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_model) %>%
  modelr::add_predictions(fit_model) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of rides per station",
       x = "predictor" ,
       y = "residual")
```


We can interpret the Beta statistics as:

* For every increase in mean air quality by 1 point, there is an increase of mean rides by 5.25, with all other variables held constant. 

* For every increase in SDI score by one point, there is a decrease of mean rides by 2.58, with all other variables held constant. 

* For every increase in percentage of residents that are overweight by 1%, there is a decrease of mean rides by 3.55, with all other variables held constant. 


```{r, eval = TRUE}
performance::check_model(fit_model, check = c("linearity", "outliers", "qq", "normality"))
```

* We also plotted the performance of our model looking at linearity, influential observations, and normality of residuals. 

##Our second model:

Outcome: Mean number of rides per start station
Predictors: 
* Health metrics for the location the start station is located in: Mean_AQI, Mean_SDI, Mean_Overweight

* Interactions including:

  * Two way interactions: Mean_AQI * Mean_SDI, Mean_AQI * Mean_Overweight, Mean_SDI * Mean_Overweight
  
  * Three way interaction: Mean_AQI * Mean_SDI * Mean_Overweight

```{r second model, eval = TRUE}
fit_model_interactions = lm(n_rides ~ mean_aq + mean_sdi + mean_overweight + mean_aq*mean_sdi + mean_aq*mean_overweight + mean_aq*mean_sdi*mean_overweight, data = citibike_group_by_station)

fit_model_interactions %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_model_interactions) %>%
  modelr::add_predictions(fit_model_interactions) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of rides per station - with interaction terms",
       x = "predictor" ,
       y = "residual")
```

We can interpret the Beta statistics as:

* For every increase in mean air quality by 1 point, there is a decrease of mean rides by 2.31, with all other variables held constant. 

* For every increase in SDI score by one point, there is a decrease of mean rides by 4.61, with all other variables held constant. 

* For every increase in precentage of residents that are overweight by 1%, there is a decrease of mean rides by 2.36, with all other variables held constant. 

* However, with interaction terms, we can see ______


```{r, eval = TRUE}
performance::check_model(fit_model_interactions, check = c("linearity", "outliers", "qq", "normality"))
```


## Cross-Validation of our Regression Models 

First we built a cross-validation by 100 splits (where there are no missing values). We will utilize this to evaluate the models by calculating their RMSE.

```{r CV, eval = TRUE}
cv_df = citibike_group_by_station[complete.cases(citibike_group_by_station$mean_aq), ] %>%
  crossv_mc(100) 

#cv_df =  crossv_mc(citibike_group_by_station, 100) 

cv_df = 
  cv_df |> 
  mutate(
    fit_model  = map(train, \(df) lm(n_rides ~ mean_aq + mean_sdi + mean_overweight, data = df)), 
    fit_model_interactions  = map(train, \(df) lm(n_rides ~ mean_aq + mean_sdi + mean_overweight + mean_aq*mean_sdi + mean_aq*mean_overweight + mean_aq*mean_sdi*mean_overweight, data = df))) |>  
  mutate(
    rmse_model = map2_dbl(fit_model, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_model_interactions = map2_dbl(fit_model_interactions, test, \(mod, df) rmse(model = mod, data = df)))
```

Density plot:
```{r density plot, eval = TRUE}
cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + geom_violin() +
  labs(title = "Density Plot of RMSE values", 
       x = "Model",
       y = "Frequency")
```

* Our density plot does show that there is a wide range of values for our models, suggesting there may be difficulty in accurately predicing out outcome of mean rides with our input variables.

```{r}
performance::compare_performance(fit_model, fit_model_interactions)
```

* Our model without interaction terms had an R2 of 0.238

* Our model with interaction terms had an R2 of 0.340


## Reverse regression models:

Next we sought to see if there were any reverse predictive relationships. Such that with a combination of mean number of rides and the other health metrics, we could predict the outcome of mean AQI, SDI, or percentage overweight for a location. 

```{r predict overweight}
fit_overweight = lm(mean_overweight ~ mean_aq + mean_sdi + n_rides, data = citibike_group_by_station)

fit_overweight %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_overweight) %>%
  modelr::add_predictions(fit_overweight) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of mean percentage overweight",
       x = "predictor" ,
       y = "residual")
```

When interpreting the beta statistics for predicting percentage overweight:

* For every increase in Air quality by one point, there is a decrease of mean percentage overweight by 29.59

* For every increase in SDI by one point, there is an increase in mean percentage overweight by 18.18

* For every increase in mean number of rides by one, there is a decrease in mean percentage overweight by 3.55

```{r predict AQI}
fit_AQI = lm(mean_aq ~ mean_overweight + mean_sdi + n_rides, data = citibike_group_by_station)

fit_AQI %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_AQI) %>%
  modelr::add_predictions(fit_AQI) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of mean AQI",
       x = "predictor" ,
       y = "residual")
```

When interpreting the beta statistics for predicting Air quality:

* For every increase in mean overweight by one point, there is a decrease of mean  AQI by 29.59

* For every increase in SDI by one point, there is an increase in mean AQI by 4.35

* For every increase in mean number of rides by one, there is a increase in mean AQI by 5.26


```{r predict SDI}
fit_sdi = lm(mean_sdi ~ mean_aq + mean_overweight + n_rides, data = citibike_group_by_station)

fit_sdi %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_sdi) %>%
  modelr::add_predictions(fit_sdi) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of mean SDI",
       x = "predictor" ,
       y = "residual")
```

When interpreting the beta statistics for predicting SDI score:

* For every increase in mean AQI by one point, there is a increase of mean SDI by 4.36

* For every increase in mean overweight by one point, there is an increase in mean SDI by 18,18

* For every increase in mean number of rides by one, there is a decrease in mean SDI by 2.58


```{r}
cv_df = citibike_group_by_station[complete.cases(citibike_group_by_station$mean_aq), ] %>%
  crossv_mc(100) 

#cv_df =  crossv_mc(citibike_group_by_station, 100) 

cv_df = 
  cv_df |> 
  mutate(
    fit_overweight  = map(train, \(df) lm(mean_overweight ~ mean_aq + mean_sdi + n_rides, data = df)), 
    fit_sdi  = map(train, \(df) lm(mean_sdi ~ mean_aq + mean_overweight + n_rides, data = df)), 
    fit_AQI  = map(train, \(df) lm(mean_aq ~ mean_overweight + mean_sdi + n_rides, data = df))) |>  
  mutate(
    rmse_overweight = map2_dbl(fit_overweight, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_sdi = map2_dbl(fit_sdi, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_AQI = map2_dbl(fit_AQI, test, \(mod, df) rmse(model = mod, data = df)))

cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + geom_violin() +
  labs(title = "Density Plot of RMSE values", 
       x = "Model",
       y = "Frequency")
```

* Here we can see that there is a much large spread compared to our RMSE density plots when predicting for mean number of rides. However, the least spread of RMSE values are for AQI, and largest are for SDI as outcomes.

```{r}
performance::compare_performance(fit_overweight, fit_sdi, fit_AQI)
```

* We can see that the model with the highest R2 was when the outcome was overweight values. 
