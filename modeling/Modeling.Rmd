---
title: "Modeling"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    code_folding: hide
css: styles.css
---

#Regression Models for Statistical Analyses 

For regression analysis, the merged data set was read and imported in. 

. A variable, ab_change was created to quantify the change in abortion restriction status per state (ab_change = 1 if Roe v. Wade added an abortion restriction that was not previously in place; ab_change = 0 if the overturning of Roe v. Wade did not change abortion restrictions). This variable was created by taking the difference between abortion restriction status in 2022 and 2018.

To better characterize and understand the relationships between our data, we sought to create models:



## Citibike + health metrics modeling

Our exploratory analyses noted some interesting trends in the Citibike data for NYC (in particular ***), as well as in the health metrics (___). 

As such, we sought to devise models that assessed the relationships between 1) rides taken in a zip code ___, and how predictor variables (stations available, SDI score, percentage overweight, and AQI values of ***) influenced that. 

We created several models, first looking at the values without 

```{r libraries, include = FALSE}
library(tidyverse)
library(mgcv)
library(modelr)
library(purrr)
library(here)
```


```{r first model, eval = TRUE}
citibike.df = read_csv(here("./citibike/citibike_clean.csv"))

citibike_group_by_station <- citibike.df %>%
  group_by(start_station_name) %>%
  summarize(n_rides = n(), 
            mean_aq = mean(start_aq),
            mean_sdi = mean(start_sdi_score), 
            mean_overweight = mean(start_percent_overweight), 
            mean_end_aq = mean(end_aq),
            mean_end_sdi = mean(end_sdi_score),
            mean_end_overweight = mean(end_percent_overweight),
            mean_age = mean(age)
  )

fit_model = lm(n_rides ~ mean_aq + mean_sdi + mean_overweight, data = citibike_group_by_station)

fit_model %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_model) %>%
  modelr::add_predictions(fit_model) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of rides per station",
       x = "predictor" ,
       y = "residual")

```

```{r second model, eval = TRUE}
fit_model_interactions = lm(n_rides ~ mean_aq + mean_sdi + mean_overweight + mean_aq*mean_sdi + mean_aq*mean_overweight + mean_aq*mean_sdi*mean_overweight, data = citibike_group_by_station)

fit_model_interactions %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_model_interactions) %>%
  modelr::add_predictions(fit_model_interactions) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of rides per station",
       x = "predictor" ,
       y = "residual")
```


```{r CV, eval = TRUE}
cv_df = citibike_group_by_station[complete.cases(citibike_group_by_station$mean_aq), ] %>%
  crossv_mc(100) 

#cv_df =  crossv_mc(citibike_group_by_station, 100) 

cv_df = 
  cv_df |> 
  mutate(
    fit_model  = map(train, \(df) lm(n_rides ~ mean_aq + mean_sdi + mean_overweight, data = df)), 
    fit_model_interactions  = map(train, \(df) lm(n_rides ~ mean_aq + mean_sdi + mean_overweight + mean_aq*mean_sdi + mean_aq*mean_overweight + mean_aq*mean_sdi*mean_overweight, data = df))) |>  
  mutate(
    rmse_model = map2_dbl(fit_model, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_model_interactions = map2_dbl(fit_model_interactions, test, \(mod, df) rmse(model = mod, data = df)))
```

```{r density plot, eval = TRUE}
cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + geom_violin() +
  labs(title = "Density Plot of RMSE values", 
       x = "Model",
       y = "Frequency")
```

```{r, eval = TRUE}
performance::check_model(fit_model, check = c("linearity", "outliers", "qq", "normality"))
```


```{r health outcomes as outcome}
fit_overweight = lm(mean_overweight ~ mean_aq + mean_sdi + n_rides, data = citibike_group_by_station)

fit_overweight %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_overweight) %>%
  modelr::add_predictions(fit_overweight) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of mean percentage overweight",
       x = "predictor" ,
       y = "residual")

fit_AQI = lm(mean_aq ~ mean_overweight + mean_sdi + n_rides, data = citibike_group_by_station)

fit_AQI %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_AQI) %>%
  modelr::add_predictions(fit_AQI) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of mean AQI",
       x = "predictor" ,
       y = "residual")

fit_sdi = lm(mean_sdi ~ mean_aq + mean_overweight + n_rides, data = citibike_group_by_station)

fit_sdi %>%
  broom::tidy() %>%
  knitr::kable()

citibike_group_by_station %>%
  modelr::add_residuals(fit_sdi) %>%
  modelr::add_predictions(fit_sdi) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() + 
  labs(title = "Model of mean SDI",
       x = "predictor" ,
       y = "residual")
```

```{r}
cv_df = citibike_group_by_station[complete.cases(citibike_group_by_station$mean_aq), ] %>%
  crossv_mc(100) 

#cv_df =  crossv_mc(citibike_group_by_station, 100) 

cv_df = 
  cv_df |> 
  mutate(
    fit_overweight  = map(train, \(df) lm(mean_overweight ~ mean_aq + mean_sdi + n_rides, data = df)), 
    fit_sdi  = map(train, \(df) lm(mean_sdi ~ mean_aq + mean_overweight + n_rides, data = df)), 
    fit_AQI  = map(train, \(df) lm(mean_aq ~ mean_overweight + mean_sdi + n_rides, data = df))) |>  
  mutate(
    rmse_overweight = map2_dbl(fit_overweight, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_sdi = map2_dbl(fit_sdi, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_AQI = map2_dbl(fit_AQI, test, \(mod, df) rmse(model = mod, data = df)))

cv_df |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") |> 
  mutate(model = fct_inorder(model)) |> 
  ggplot(aes(x = model, y = rmse)) + geom_violin() +
  labs(title = "Density Plot of RMSE values", 
       x = "Model",
       y = "Frequency")
```

```{r}
performance::compare_performance(fit_overweight, fit_sdi, fit_AQI)
```

