---
title: "<span style='color: blue;'>Project Report: From Pedals to Patterns: A P8105 Citibike Data Analysis</span>"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
css: styles.css
---
<style>
  h1 {
    text-align: center;
     font-weight: bold;
  }
</style>

  &nbsp;
  
```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(plotly)
library(patchwork)

knitr::opts_chunk$set(message = FALSE,
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

library(ggridges)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r load_data, include = FALSE}
citibike_df = read_csv("./citibike_clean/citibike_clean.csv")
stations_df = read_csv("./citibike_clean/stations.csv")
```


***

## <span style='color: blue;'>Team Members</span>
  - Laura O'Carroll, lgo2107<br>
  - Courtney Diamond, cjd2195<br>
  - Hyun Jin Jung, hj2660<br>
  - Jesus Luevano, jl5934<br>
  - Kayla Schiffer-Kane, khs2138<br>
  - Haley Zylberberg, hmz2105<br> 
  
    &nbsp;

***

## <span style='color: blue;'>Motivation</span>

Increasing transportation costs, congested streets, and subway delays across New York City are pressuring residents to find cheaper and faster means of navigating the Big Apple. The introduction of [Citibike](https://citibikenyc.com/) has had an impact in increasing access to biking as an alternative means of transportation. Biking also has the added benefit of promoting health! However, a critical question emerges: How do NYers in different neighborhoods use citibike, and how do environmental, health, and socioeconomic variables impact ridership and access to rides? 

As public health students grappling with the daily commute in the dynamic landscape of NYC, we are driven by a curiosity to determine the viability and equity of turning to CitiBike as a transportation alternative. Our exploration is multi-faceted, aiming to explore the intricacies of CitiBike use:

   * <u>Geographical Utilization</u>: We seek to explore the patterns of CitiBike usage throughout the diverse neighborhoods of NYC. Understanding where and when these bikes are utilized is key to discerning the impact on urban mobility.
   
  * <u>User Demographics</u>: A crucial part of our exploration involves identifying the demographics of CitiBike users. 
  
  * <u>Health Implications</u>: Beyond transportation statistics, we aim to explore whether CitiBike use is related to health disparities and socioeconomic variables among NYers. This involves exploring associations between CitiBike ridership and bike availability with social deprivation indices (SDI), air quality, and being overweight.

Overall, we aim to understand how CitiBike intersects with public health and urban life in NYC.

  &nbsp;

***
## <span style='color: blue;'>Related Work</span>

After spending time on the airbnb data sources in class, we were particularly interested in exploring an NYC dataset. As we are public health students and our group also includes healthcare professionals our focus naturally gravitated toward a dataset with potential relevance to the health of NYers. While we evaluated several potential data sources, we were collectively interested in Citibike usage data, as we recognized its potential to offer valuable insights into the intersection of transportation patterns and public health in NYC.

  &nbsp;

***

## <span style='color: blue;'>Initial Questions</span>

Initially, our view of this project was very grandiose. We wanted to explore all Citibike usage patterns throughout 2019. We specifically chose 2019 as we wanted to use the social deprivation index score which was most recently available for 2019. However, we quickly realized that examining data from all of 2019 was too much data (around 1 million rides) and consistently led to problems knitting. Instead we decided to limit our data to one month, September, which had the largest number of rides. The trade off was that we were unable to examine seasonal trends and ridership. We were particularly interested in rides and ridership during times of year that suggested tourist usage, especially around holidays, but this area of exploration was discarded.

Instead, we focused on questions related to Citibike usership and geographic utilization? Throughout the evolution of our project, we also decided to emphasize the exploration of health and socioeconomic variables, which introduced a more nuanced layer to our data exploration by providing a health and equity lens. 

We specifically wanted to answer the following questions:

### 1. Geographic Utilization

   a. How many stations are there in each neighborhood and borough of NYC?
   
   b. Where are the most common stations?

### 2. User Demographics

   a. Who is the typical Citibike User?

### 3. Health Implications

   a. Are there disparities in Citibike stations per neighborhood or ridership? Is there a relationship to the social deprivation index.
   
   b. Are there differences in Citibike stations per neighborhood or ridership that is related to obesity? 
   
   c. How do these variables interact? Can we build a model of Citibike utilization that integrates disparities, both social and environmental, and also health factors.


***

## <span style='color: blue;'>Data</span>

Data: Source, scraping method, cleaning, etc.

  &nbsp;

***

## <span style='color: blue;'>Exploratory Analysis</span>

  &nbsp;

Citibike Geographic Analysis

We made a table of the stations used and available per neighborhood.

```{r station_usage, echo=FALSE}
stations_available = stations_df|>
  group_by(borough, uhf34_neighborhood) |>
  summarize(Stations_Available = n()) 

station_usage = citibike_df |>
  filter(!is.na(end_station_name) | !is.na(start_station_name)) %>%
  select(end_station_name, end_uhf34_neighborhood, 
         start_station_name, start_uhf34_neighborhood,
         start_borough, end_borough) |>
  distinct(
    Neighborhood = coalesce(end_uhf34_neighborhood, start_uhf34_neighborhood),
    Station_Name = coalesce(end_station_name, start_station_name),
    Borough = coalesce(end_borough, start_borough)
    ) |>
  group_by(Borough, Neighborhood) |>
  summarize(Stations_Used = n()) |>
  left_join(stations_available,
            by = c("Borough" = "borough",
                   "Neighborhood" = "uhf34_neighborhood")) 
station_usage |>
  arrange(Borough, desc(Stations_Used)) |>
  knitr::kable()

```
  &nbsp;

We next looked at number of rides per borough.

![](analysis_files/figure-html/graph of station stop/start per borough-1.png)
  &nbsp;

And the 10 most popular starting and stopping stations.

![](analysis_files/figure-html/start stations-1.png)
  &nbsp;
  
Citibike user demographics

![](analysis_files/figure-html/user_demographics-1.png)
 &nbsp;
 
Citibike Geographic Utilization with Health Metrics 

  * We used median SDI for our analyses as this more accurately reflects the variation in SDI score across zip codes in a neighborhood. See [here](Exploration.html) for a more detailed description.
  
 &nbsp;

We looked at median SDI and station use/availability by neighborhood.

![](analysis_files/figure-html/sdi_stations-1.png)
 &nbsp;

And we looked at percentage overweight and station use/availability by neighborhood

![](analysis_files/figure-html/overweight_stations-1.png)
 &nbsp;

Citibike Ridership and Health Metrics

* We looked at zipcodes instead of neighborhood in order to have more datapoints to evaluate a trend (we only had 20 neighborhoods.)

We looked at ridership and median SDI by zipcode

![](analysis_files/figure-html/sdi_rides_zipcode-1.png)
 &nbsp;
 
And ridership and percentage overweight at the zipcode level, while also looking at SDI.

![](analysis_files/figure-html/overweight_rides_zipcode-1.png)
&nbsp;

The best part is that we made an interactive [dashboard](https://courtneyjdiamond.shinyapps.io/ExploratoryDashboard/) to visualize the relationship between Citibike and the health variables all together!

&nbsp;

Exploration of Health Metrics

Finally, we performed an exploration of of the health variables individually by NYC location. For the full page, [check this out](Exploration.html), but here are some highlights.

Median SDI by Neighborhood in 2019.

![](Exploration_files/figure-html/sdi neighborhood-1.png)

Mean Fine Particles by Neighborhood in 2019.

![](Exploration_files/figure-html/particles_neighborhood-1.png)

Percent of adults classified as overweight or obese by neighborhood.

![](Exploration_files/figure-html/uhf-1.png)

We also made this plot of latitute/longitude of NYC by SDI, percentage overweight, and AQI (Mean fine particle (PM 2.5)) below. 

```{r , echo=FALSE}
health_plot = citibike_df |>
  select(start_station_latitude, start_station_longitude,
        start_sdi_score, start_percent_overweight, start_aq) |> 
  rename(lat = start_station_latitude, 
         long = start_station_longitude,
         sdi = start_sdi_score,
         overweight = start_percent_overweight,
         aq = start_aq) |>
  unique()

health_plot |>
  mutate(text_label = str_c("SDI: ", sdi, "\nOverweight (%) ", 
                            overweight, "\nAQ (PM25): ", aq)) |> 
  plot_ly(x = ~long, y = ~lat, type = "scatter", mode = "markers",
          color = ~sdi, text = ~text_label)

```

***

## <span style='color: blue;'>Additional Analysis: Modeling</span>

Health Metric Modeling

Before building a model to understanding how health metrics play into Citibike usage, we wanted to explore interactions among the SDI and percentage overweight themselves.

![](scatter_plot.png)
Citibike with Health Metric Modeling

Next, we build upon our exploratory analyses by pursuing GLM with two sets of outcome in mind. 

  * The first was utilization of Citibike in a geographic area, based on health factors in the form of median Air quality, median SDI, and overweight percentages. This utilized a linear model that at first took these three predictors separately into consideration. 
  * We then created an interaction model that included each of the three individual predictors, but added all possible two-way interactions, and a three-way interaction as we hypothesized that the health, environmental influences, and utilization of biking as a mode of transportation and leisure were related. 

We found that the models had significant Beta statistics, but overall had very variable RMSE values in our cross-validation analyses. We also found the R2 to be low for both. 

![](modeling/compare_rides_models.png)

We then sought to see if conversely health metrics may be able to be predicted by the other metrics, and Citibike utilization. We created three linear models to predict for Air Quality, SDI, and percentage overweight each, using the other factors and number of rides as the predictors. 

* We found that the models had less variability in RMSE, and higher R2 values, in particular for percentage overweight. 

![](modeling/compare_healthoutcomes.png)

  &nbsp;

***

## <span style='color: blue;'>Discussion</span>
Discussion: What were your findings? Are they what you expect? What insights into the data can you make?
